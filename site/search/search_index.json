{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Home Center of Knowledge. \ud83d\ude09 Bug Le proxy pr\u00e9sent sur le site Atos de Bezons, bloque toutes connexions \u00e0 la plateforme. Pour contourner la restriction, changez votre adresse MAC ou passer en partage de connexion sur votre r\u00e9seau mobile. Demander un acc\u00e8s \u00e0 l'hyperviseur proxmox Pour demander un acc\u00e8s \u00e0 cette plateforme, il suffit d'envoyer un mail \u00e0 : john.2.allen@atos.net nicolas.becu@atos.net Formatez la demande de la fa\u00e7on suivante : Nom : Nom de l'utilisateur \u00e0 cr\u00e9er Prenom : Pr\u00e9nom de l'utilisateur \u00e0 cr\u00e9er Email : Email de l'utilisateur \u00e0 cr\u00e9er Objet : Raison de la cr\u00e9ation de compte ISO : Nom de l'ISO n\u00e9cessaire reseau : Besoin ou pas de r\u00e9seau priv\u00e9 projet : Projet associ\u00e9 \u00e0 la demande Example : Example Nom : Nicolas Prenom : Becu Email : nicolas.becu@atos.net Objet : \"Besoin d'un acc\u00e8s pour d\u00e9ployer un cluster kubernetes\" ISO : talos-1.2.iso reseau priv\u00e9 : oui projet : casio Caution Le mot de passe est \u00e0 changer d\u00e8s r\u00e9ception de vos informations personnelles de connexion. La double authentification ( TFA ) est obligatoire. Les comptes qui en seront d\u00e9pourvus seront d\u00e9sactiv\u00e9s. Demander un acc\u00e8s VPN Pour demander un acc\u00e8s \u00e0 cette plateforme, il suffit d'envoyer un mail \u00e0 : john.2.allen@atos.net nicolas.becu@atos.net En fonction du syst\u00e8me d'exploitation une connexion VPN adapt\u00e9e sera fournie. Wireguard La mise en place d'un tunnel VPN Wireguard n\u00e9cessite l'\u00e9change de cl\u00e9 chifr\u00e9e. Vous pouvez demander que l'on vous g\u00e9n\u00e8re ces cl\u00e9s ou les g\u00e9n\u00e9rer vous m\u00eame en suivant cette proc\u00e9dure . Dans le cas o\u00f9 vous g\u00e9n\u00e9rez votre propre paire de cl\u00e9s chiffr\u00e9es pouvez r\u00e9cup\u00e9rer le bout de fichier suivant pour configurer votre client. Quelques champs sont \u00e0 compl\u00e9ter ou \u00e0 modifier : Adsress : Renseigner l'adresse IP fournie lors de la demande PrivateKey : Renseigner la cl\u00e9 priv\u00e9e g\u00e9n\u00e9r\u00e9e PublicKey : s/cms7Td92Ywog2G8+789Qnudx0y5qImdvhkSaZEAhI= Il faudra \u00e9galement transmettre dans le mail la cl\u00e9 publique que vous avez g\u00e9n\u00e9r\u00e9e. Info Dans le cas o\u00f9 vous de souhaitez pas g\u00e9n\u00e9rer votre propre paire de cl\u00e9 chiffr\u00e9es, un fichier rempli vous sera transmis. [Interface] Address = 10.0.1.x/32 PrivateKey = DNS = 10.0.0.1 [Peer] PublicKey = Endpoint = rt.aosc-portal.com:51820 AllowedIPs = 0.0.0.0/0 PersistentKeepalive = 30 Tip Pour t\u00e9l\u00e9charger le client sp\u00e9cifique \u00e0 son syst\u00e8me, rendez-vous sur la page de t\u00e9l\u00e9chargement officielle. Pour plus de d\u00e9tails, se r\u00e9f\u00e9rer \u00e0 la documentation . OpenVPN Pour OpenVPN, il suffit d'importer le fichier de configuration fourni dans son client OpenVPN. Pour plus d'informations, se r\u00e9f\u00e9rer \u00e0 la documentation li\u00e9es. Demande d'un acc\u00e8s bastion pour ProxyJump SSH Pour demander un acc\u00e8s \u00e0 cette plateforme, il suffit d'envoyer un mail \u00e0 : john.2.allen@atos.net nicolas.becu@atos.net Tip Ne pas oublier de joindre une cl\u00e9 public SSH \u00e0 la demande, sans quoi aucun acc\u00e8s ne pourra \u00eatre cr\u00e9\u00e9. Bonnes pratiques Lors de la cr\u00e9ation d'une machine virtuelle, il convient d'ins\u00e9rer dans les notes les informations suivantes pour aider le suivi automatis\u00e9 de celle-ci : owner : Propri\u00e9taire ou responsable de la machine virtuelle creator : Personne \u00e0 l'origine de la cr\u00e9ation de la machine virtuelle creation : Date de cr\u00e9ation de la machine virtuelle expiration : Date de fin d'utilit\u00e9 de la machine virtuelle project : Projet li\u00e9 \u00e0 l'existance de la machine virtuelle usage : Cas d'usage de la machine virtuelle Pour cela, il suffit d'ouvrir les notes de la vm et de renseigner les information au format yaml : Example Pour exemple, voici les notes renseign\u00e9es pour la machine virtuelle PfSense : owner : Nicolas Becu creator : Nicolas Becu creation : 2022/09/01 expiration : no project : sandbox usage : Routeur logiciel pour la gestion du r\u00e9seau de la plateforme Caution Toutes les machines virtuelles d\u00e9pourvues de ces informations seront supprim\u00e9es dans la semaine suivant leurs d\u00e9tections. Tra\u00e7abilit\u00e9 Un script est disponible ici pour faire un rapport automatis\u00e9 de l'utilisation de la plateforme Documentation La documentation est fournie par MkDocs. Chaque personnes ayant les droits requis sur le d\u00e9p\u00f4t peut l'\u00e9diter pour ajouter ou mettre \u00e0 jour des informations. Installation Installer MkDocs simplement avec le gestionnaire de paquet python : sudo pip3 install mkdocs Le th\u00e8me de MkDocs est Material , il s'installe \u00e9galement avec le gestionnaire de paquet python : sudo pip3 install mkdocs-material Un plugin est actuellement en phase de test pour l'int\u00e9gration de solution de sch\u00e9matisation. \u00c9tant dans la configuration de MkDocs, il est \u00e9galement \u00e0 installer avec le gestionnaire de paquet python : sudo pip3 install mkdocs-kroki-plugin Configuration La configuration du wiki se trouve \u00e0 la racine du d\u00e9p\u00f4t, dans le fichier mkdocs.yaml . Si besoin, il est possible de rajouter de nouvelle entr\u00e9es dans la navigation. Chaque entr\u00e9e correspond \u00e0 un menu de la navigation et chaque sous entr\u00e9e correspond \u00e0 une redirection d'url. nav : - Home : index.md - Proxmox : - 'Installation' : 'proxmox/#installation' - 'Gestion des acc\u00e8s' : 'proxmox/#gestion-des-acces' - 'Probl\u00e8mes connus' : 'proxmox/#problemes-connus' - 'Gestion de la virtualisation' : 'proxmox/#gestion-de-la-virtualisation' - PfSense : - 'OVH' : 'pfsense/#ovh' - 'Gestion du r\u00e9seau' : 'pfsense/#gestion-du-reseau' - 'Gestion des acc\u00e8s' : 'pfsense/#les-acces' - 'Wireguard' : 'pfsense/#wireguard' - 'REST API' : 'pfsense/#rest-api' Warning Ne pas toucher les configuration de plugins sans connaissances du syst\u00e8me MkDocs ! Usage Lors de l'\u00e9dition locale de du wiki, il est particuli\u00e8rement pratique de pouvoir visualiser le rendu des modifications op\u00e9r\u00e9es. Pour cela, il est possible de d\u00e9ployer le wiki localement : mkdocs serve Tip Ne pas oublier de commiter le code puis de le pousser sur la branch main pour mettre \u00e0 disposition \u00e0 tous les collaborateurs, la derni\u00e8re version du wiki. Lorsque le r\u00e9sultat final est obtenu, il suffit le pousser sur la branch distante : mkdocs gh-deploy Info MkDocs g\u00e8re seul le d\u00e9ploiement du wiki sur github. Le code va ainsi \u00eatre transformer en site statique puis pouss\u00e9 sur une branch distinct. Les pages github pointent sur la racine de cette branche pour exposer le wiki.","title":"Home"},{"location":"#home","text":"Center of Knowledge. \ud83d\ude09 Bug Le proxy pr\u00e9sent sur le site Atos de Bezons, bloque toutes connexions \u00e0 la plateforme. Pour contourner la restriction, changez votre adresse MAC ou passer en partage de connexion sur votre r\u00e9seau mobile.","title":"Home"},{"location":"#demander-un-acces-a-lhyperviseur-proxmox","text":"Pour demander un acc\u00e8s \u00e0 cette plateforme, il suffit d'envoyer un mail \u00e0 : john.2.allen@atos.net nicolas.becu@atos.net Formatez la demande de la fa\u00e7on suivante : Nom : Nom de l'utilisateur \u00e0 cr\u00e9er Prenom : Pr\u00e9nom de l'utilisateur \u00e0 cr\u00e9er Email : Email de l'utilisateur \u00e0 cr\u00e9er Objet : Raison de la cr\u00e9ation de compte ISO : Nom de l'ISO n\u00e9cessaire reseau : Besoin ou pas de r\u00e9seau priv\u00e9 projet : Projet associ\u00e9 \u00e0 la demande Example : Example Nom : Nicolas Prenom : Becu Email : nicolas.becu@atos.net Objet : \"Besoin d'un acc\u00e8s pour d\u00e9ployer un cluster kubernetes\" ISO : talos-1.2.iso reseau priv\u00e9 : oui projet : casio Caution Le mot de passe est \u00e0 changer d\u00e8s r\u00e9ception de vos informations personnelles de connexion. La double authentification ( TFA ) est obligatoire. Les comptes qui en seront d\u00e9pourvus seront d\u00e9sactiv\u00e9s.","title":"Demander un acc\u00e8s \u00e0 l'hyperviseur proxmox"},{"location":"#demander-un-acces-vpn","text":"Pour demander un acc\u00e8s \u00e0 cette plateforme, il suffit d'envoyer un mail \u00e0 : john.2.allen@atos.net nicolas.becu@atos.net En fonction du syst\u00e8me d'exploitation une connexion VPN adapt\u00e9e sera fournie.","title":"Demander un acc\u00e8s VPN"},{"location":"#wireguard","text":"La mise en place d'un tunnel VPN Wireguard n\u00e9cessite l'\u00e9change de cl\u00e9 chifr\u00e9e. Vous pouvez demander que l'on vous g\u00e9n\u00e8re ces cl\u00e9s ou les g\u00e9n\u00e9rer vous m\u00eame en suivant cette proc\u00e9dure . Dans le cas o\u00f9 vous g\u00e9n\u00e9rez votre propre paire de cl\u00e9s chiffr\u00e9es pouvez r\u00e9cup\u00e9rer le bout de fichier suivant pour configurer votre client. Quelques champs sont \u00e0 compl\u00e9ter ou \u00e0 modifier : Adsress : Renseigner l'adresse IP fournie lors de la demande PrivateKey : Renseigner la cl\u00e9 priv\u00e9e g\u00e9n\u00e9r\u00e9e PublicKey : s/cms7Td92Ywog2G8+789Qnudx0y5qImdvhkSaZEAhI= Il faudra \u00e9galement transmettre dans le mail la cl\u00e9 publique que vous avez g\u00e9n\u00e9r\u00e9e. Info Dans le cas o\u00f9 vous de souhaitez pas g\u00e9n\u00e9rer votre propre paire de cl\u00e9 chiffr\u00e9es, un fichier rempli vous sera transmis. [Interface] Address = 10.0.1.x/32 PrivateKey = DNS = 10.0.0.1 [Peer] PublicKey = Endpoint = rt.aosc-portal.com:51820 AllowedIPs = 0.0.0.0/0 PersistentKeepalive = 30 Tip Pour t\u00e9l\u00e9charger le client sp\u00e9cifique \u00e0 son syst\u00e8me, rendez-vous sur la page de t\u00e9l\u00e9chargement officielle. Pour plus de d\u00e9tails, se r\u00e9f\u00e9rer \u00e0 la documentation .","title":"Wireguard"},{"location":"#openvpn","text":"Pour OpenVPN, il suffit d'importer le fichier de configuration fourni dans son client OpenVPN. Pour plus d'informations, se r\u00e9f\u00e9rer \u00e0 la documentation li\u00e9es.","title":"OpenVPN"},{"location":"#demande-dun-acces-bastion-pour-proxyjump-ssh","text":"Pour demander un acc\u00e8s \u00e0 cette plateforme, il suffit d'envoyer un mail \u00e0 : john.2.allen@atos.net nicolas.becu@atos.net Tip Ne pas oublier de joindre une cl\u00e9 public SSH \u00e0 la demande, sans quoi aucun acc\u00e8s ne pourra \u00eatre cr\u00e9\u00e9.","title":"Demande d'un acc\u00e8s bastion pour ProxyJump SSH"},{"location":"#bonnes-pratiques","text":"Lors de la cr\u00e9ation d'une machine virtuelle, il convient d'ins\u00e9rer dans les notes les informations suivantes pour aider le suivi automatis\u00e9 de celle-ci : owner : Propri\u00e9taire ou responsable de la machine virtuelle creator : Personne \u00e0 l'origine de la cr\u00e9ation de la machine virtuelle creation : Date de cr\u00e9ation de la machine virtuelle expiration : Date de fin d'utilit\u00e9 de la machine virtuelle project : Projet li\u00e9 \u00e0 l'existance de la machine virtuelle usage : Cas d'usage de la machine virtuelle Pour cela, il suffit d'ouvrir les notes de la vm et de renseigner les information au format yaml : Example Pour exemple, voici les notes renseign\u00e9es pour la machine virtuelle PfSense : owner : Nicolas Becu creator : Nicolas Becu creation : 2022/09/01 expiration : no project : sandbox usage : Routeur logiciel pour la gestion du r\u00e9seau de la plateforme Caution Toutes les machines virtuelles d\u00e9pourvues de ces informations seront supprim\u00e9es dans la semaine suivant leurs d\u00e9tections.","title":"Bonnes pratiques"},{"location":"#tracabilite","text":"Un script est disponible ici pour faire un rapport automatis\u00e9 de l'utilisation de la plateforme","title":"Tra\u00e7abilit\u00e9"},{"location":"#documentation","text":"La documentation est fournie par MkDocs. Chaque personnes ayant les droits requis sur le d\u00e9p\u00f4t peut l'\u00e9diter pour ajouter ou mettre \u00e0 jour des informations.","title":"Documentation"},{"location":"#installation","text":"Installer MkDocs simplement avec le gestionnaire de paquet python : sudo pip3 install mkdocs Le th\u00e8me de MkDocs est Material , il s'installe \u00e9galement avec le gestionnaire de paquet python : sudo pip3 install mkdocs-material Un plugin est actuellement en phase de test pour l'int\u00e9gration de solution de sch\u00e9matisation. \u00c9tant dans la configuration de MkDocs, il est \u00e9galement \u00e0 installer avec le gestionnaire de paquet python : sudo pip3 install mkdocs-kroki-plugin","title":"Installation"},{"location":"#configuration","text":"La configuration du wiki se trouve \u00e0 la racine du d\u00e9p\u00f4t, dans le fichier mkdocs.yaml . Si besoin, il est possible de rajouter de nouvelle entr\u00e9es dans la navigation. Chaque entr\u00e9e correspond \u00e0 un menu de la navigation et chaque sous entr\u00e9e correspond \u00e0 une redirection d'url. nav : - Home : index.md - Proxmox : - 'Installation' : 'proxmox/#installation' - 'Gestion des acc\u00e8s' : 'proxmox/#gestion-des-acces' - 'Probl\u00e8mes connus' : 'proxmox/#problemes-connus' - 'Gestion de la virtualisation' : 'proxmox/#gestion-de-la-virtualisation' - PfSense : - 'OVH' : 'pfsense/#ovh' - 'Gestion du r\u00e9seau' : 'pfsense/#gestion-du-reseau' - 'Gestion des acc\u00e8s' : 'pfsense/#les-acces' - 'Wireguard' : 'pfsense/#wireguard' - 'REST API' : 'pfsense/#rest-api' Warning Ne pas toucher les configuration de plugins sans connaissances du syst\u00e8me MkDocs !","title":"Configuration"},{"location":"#usage","text":"Lors de l'\u00e9dition locale de du wiki, il est particuli\u00e8rement pratique de pouvoir visualiser le rendu des modifications op\u00e9r\u00e9es. Pour cela, il est possible de d\u00e9ployer le wiki localement : mkdocs serve Tip Ne pas oublier de commiter le code puis de le pousser sur la branch main pour mettre \u00e0 disposition \u00e0 tous les collaborateurs, la derni\u00e8re version du wiki. Lorsque le r\u00e9sultat final est obtenu, il suffit le pousser sur la branch distante : mkdocs gh-deploy Info MkDocs g\u00e8re seul le d\u00e9ploiement du wiki sur github. Le code va ainsi \u00eatre transformer en site statique puis pouss\u00e9 sur une branch distinct. Les pages github pointent sur la racine de cette branche pour exposer le wiki.","title":"Usage"},{"location":"pfsense/","text":"PfSense OVH La machine virtuelle PfSense dispose d'un acc\u00e8s internet gr\u00e2ce \u00e0 un routage interne au serveur d\u00e9di\u00e9 lui permettant d'\u00eatre rattach\u00e9 \u00e0 une IP FailOver. Console web OVH Une fois connecter \u00e0 la console web d'OVH, il faut se rendre dans la section bare metal cloud et d\u00e9rouler l'onglet des serveurs d\u00e9di\u00e9s pour pouvoir choisir celui d\u00e9sir\u00e9 : Dans l'onglet de gestion des interfaces r\u00e9seaux, on ouvre la console de gestion des adresses IP du serveur : On d\u00e9place l'adresse IP sur le serveur d\u00e9sir\u00e9 : Pour finir, on ajoute une adresse MAC virtuelle \u00e0 l'adresse IP, ce qui permettra de router le traffic r\u00e9seau sur la machine virtuelle poss\u00e9dant cette adresse MAC. Configuration de la machine virtuelle On commence par configurer l'interface r\u00e9seau vmbr0 du Proxmox . Celle doit \u00eatre configur\u00e9e en static sur l'adresse public du serveur. Sa passerelle r\u00e9seau doit imp\u00e9rativement \u00eatre configur\u00e9e. Tip La configuration r\u00e9seau de l'interface principale de Proxmox est effectu\u00e9e par l'installeur. Il n'est normalement pas n\u00e9cessaire d'y toucher. Info Les r\u00e9seau OVH ont tous une passerelle en 254 . Pour conna\u00eetre sa passerelle, il suffit de prendre les 3 premiers octets de l'adresse du serveur, puis de compl\u00e9ter le dernier octet par 254 . Ensuite, on ajoute \u00e0 la machine virtuelle PfSense son interface WAN , en lui attribuant l'adresse MAC virtuelle de l'IP FailOver qui a \u00e9t\u00e9 configur\u00e9e au pr\u00e9alable. Dans l'interface web d'administration de pfsense, on configure la passerelle par d\u00e9faut qui sera utilis\u00e9e pour le routage de tout le traffic r\u00e9seau entrant et sortant. Puis on param\u00e8tre PfSense pour pointer dessus. Dans l'interface web d'administration de pfsense, on configure l'interface r\u00e9seau WAN . Gestion du r\u00e9seau Interfaces r\u00e9seaux Chaque nouvelle interface r\u00e9seau attach\u00e9e \u00e0 la machine virtuelle PfSense est instantan\u00e9ment visible dans l'interface d'aministration du routeur : Une fois la nouvelle interface ajout\u00e9e \u00e0 la gestion de PfSense, il reste \u00e0 faire la configuration de cette interface, tout en s'assurant qu'elle soit activ\u00e9e : Serveur DHCP Chaque interface \u00e0 la possibilit\u00e9 de disposer de son propre server DHCP Serveur DNS PfSense dispose de son propre r\u00e9solver DNS bas\u00e9 sur Unbound . Il r\u00e9cup\u00e8re sa r\u00e9solution publique aupr\u00e8s des serveurs DNS de CloudFlare : Il est \u00e9galement possible de rajouter des entr\u00e9es personnalis\u00e9es dans la r\u00e9solution locale : Routage interne Le routeur laisse passer sur son interface publique : Le protocole ICMP : Pour permettre le ping du routeur \u00e0 des fin surtout d'administration Le protocole SSH sur le port 2222 : Pour permettre d'acc\u00e9der en shell au routeur Le protocole UDP sur le port de WIREGUARD (51820) : Pour permettre un acc\u00e8s VPN au uilisateurs Info Des r\u00e8gles d'acc\u00e8s pour les protocoles HTTP et HTTPS sont \u00e9galement en place mais d\u00e9sactiv\u00e9es par mesure de s\u00e9curit\u00e9. Elle peuvent \u00eatre r\u00e9activ\u00e9es sur demande si besoin est (maintenance, incident, etc.) Le r\u00e9seau principale (default) est totalement ouvert sur tous le r\u00e9seau interne g\u00e9r\u00e9 par PfSense : Pour des besoins sp\u00e9cifiques, il est \u00e9galement possible de cr\u00e9er des routage restrictifs sur le traffic inter-r\u00e9seau. Comme on peut le voir sur la capture suivante, le r\u00e9seau peut communiquer avec le routeur ou avec internet. Il peut \u00e9galement communiquer avec le r\u00e9seau li\u00e9 \u00e0 Wireguard (le VPN), mais aucun autre r\u00e9seau, pas m\u00eame le d\u00e9fault ne peuvent communiquer avec lui. Gestion des acc\u00e8s Note D\u00e9finir une strat\u00e9gie d'acc\u00e8s au PfSense Acc\u00e8s SSH Chaque compte cr\u00e9\u00e9 dans le cadre d'un acc\u00e8s VPN OpenVPN se voit attribuer la possibilit\u00e9 de se connecter en shell sur le PfSense. Cela permet si besoin aux collaborateurs de faire du ProxyJump SSH si besoin (\u00e9viter d'initialiser une connexion VPN pour se connecter \u00e0 une machine virtuelle). Acc\u00e8s web internes Les acc\u00e8s web interne se font via tunnel VPN. Pour PfSense, celui ci est accessible via le domain rt.infra.aosc , ou via toute les adresses passerelles de r\u00e9seaux. Pour tout acc\u00e8s web \u00e0 une un service h\u00e9berg\u00e9 sur une machine virtuelle, il suffit d'y acc\u00e9der par son adresse IP. Acc\u00e8s web public Les acc\u00e8s web publics \u00e0 PfSense sont d\u00e9sactiv\u00e9s au niveau pare feu. Ils peuvent \u00eatre r\u00e9activ\u00e9s sur besoin en cas de probl\u00e8mes r\u00e9seaux. Pour les expositions de services herberg\u00e9s sur la sandbox, il n'est \u00e0 ce jour pas pr\u00e9vu d'exposer ces services (via reverse proxy par exemple). Les acc\u00e8s devront se faire par tunnel VPN. Wireguard PfSense fourni un acc\u00e8s VPN (Virtual Private Network) au r\u00e9seau interne de l'hyperviseur Proxmox . Installation du client Wireguard est disponible sur \u00e9norm\u00e9ment de plateformes. Pour les instructions d'installation, se r\u00e9f\u00e9rer \u00e0 la documentation officielle Gestion des cl\u00e9s chriffr\u00e9es Wireguard n\u00e9cessite l'utilisation de cl\u00e9 chifr\u00e9es priv\u00e9es et publiques. Cr\u00e9er une paire de cl\u00e9s chifr\u00e9es : wg genkey | tee privatekey | wg pubkey > publickey Il est \u00e9galement possible de se rendre sur ce site , g\u00e9n\u00e9rer une configuration al\u00e9atoire pour r\u00e9cup\u00e9rer la cl\u00e9 public et priv\u00e9e. Dans le cas o\u00f9 vous voudriez garder ces cl\u00e9s, il faudra les d\u00e9placer en lieu s\u00fbr. Dans le cas contraire, il suffit de les supprimer car plus utile. Configuration du client La m\u00e9thode la plus simple est d'utiliser un fichier de configuration. [Interface] : Configure la configuration locale Address : Adresse ip (avec CIDR ) de l'utilisateur PrivateKey : Cl\u00e9 chifr\u00e9e priv\u00e9e de l'utilisateur DNS : Serveur DNS de r\u00e9f\u00e9rence un fois connct\u00e9. [Peer] : PublicKey : Cl\u00e9 chifr\u00e9e publique du serveur distant Endpoint : Adresse / Domaine du serveur distant avec son port (ex: ip:port ) AllowedIPs : R\u00e9seaux autoris\u00e9s (Pour faire passer tous le traffic \u00e0 travers la connexion: 0.0.0.0/0) PersistentKeepalive : Persistence de la connexion en secondes Pour exemple, avec le fichier aosc.conf : [Interface] Address = 10.0.1.x/32 PrivateKey = DNS = 10.0.0.1 [Peer] PublicKey = Endpoint = rt.aosc-portal.com:51820 AllowedIPs = 0.0.0.0/0 PersistentKeepalive = 30 Connexion du client Linux Placez le fichier de configuration wireguard \u00e0 l'emplacement suivant : /etc/wireguard/aosc.conf Caution Ne pas utiliser de caract\u00e8re sp\u00e9ciaux dans le nommage du fichier. Les interface virtuelle verra leur nom bas\u00e9 sur ce fichier, cela pourrait donc faire disfonctionner le processus de connexion. Activation du tunnel VPN sudo wg-quick up aosc Affichage du statut de la connexion sudo wg D\u00e9sactivation du tunnel VPN sudo wg-quick down aosc Info Pour une configuration automatique de la r\u00e9solution DNS sur Linux , le paquet resolvconf doit \u00eatre pr\u00e9sent sur le system. Le fichier /etc/resolv.conf se doit d'\u00eatre un lien symbolique du fichier /run/resolvconf/resolv.conf . Dans le cas contraire le changement de serveur DNS du syst\u00e8me devra se faire manuellement. Windows Ouvrir le gestion de connexion Wireguard Importer la connexion \u00e0 partir d'un fichier de configuration V\u00e9rifier les informations de la nouvelle connexion Activer la connexion MacOS Ouvrir le gestionnaire de tunnel Wireguard : Choisir un fichier \u00e0 importer : V\u00e9rifier les informations : Activer la connexion : Android R\u00e9cup\u00e9rer l'application wireguard sur le play store Ajouter une nouvelle connexion \u00e0 partir d'un fichier Activer la connexion Tip Il est possible de conrt\u00f4ller la connexion avec un simple ping Int\u00e9gration \u00e0 PfSense Wireguard est int\u00e9gr\u00e9 aux d\u00e9p\u00f4ts officiels de PfSense. Ainsi, son installation se fait par le gestionnaire de paquets de la solution logicielle. Tout d'abord, chercher le paquet : Ensuite, l'installer : Configuration du serveur Pour configurer un tunnel VPN, il suffit de se rendre dans l'onglet de configuration de Wireguard : Puis, on cr\u00e9er un nouveau tunnel : Configuration des utilisateurs Pour configurer un nouvel utilisateur, il suffit de se rendre dans l'onglet de Peer : Puis, on ajoute une nouvel connexion : Gestion des routes Le r\u00e9seau Wireguard a acc\u00e8s \u00e0 l'enti\u00e8ret\u00e9 du r\u00e9seau interne : Il est \u00e9galement autoris\u00e9 \u00e0 sortir sur internet : OpenVPN Installation Le paquet OpenVPN est inclus nativement dans PfSense, il n'y a donc pas d'installation particuli\u00e8re \u00e0 faire. Configuration Tout d'abord, il faut cr\u00e9er le certificat d'autorit\u00e9 qui sera utilis\u00e9 par le serveur OpenVPN : Ensuite vient la cr\u00e9ation du certificat server sign\u00e9 par le certification d'authorit\u00e9 qui sera utilis\u00e9 par le serveur OpenVPN : Pour finir, il faut cr\u00e9er le server OpenVPN : Routage Le routage du r\u00e9seau virtuelle du serveur OpenVPN est compl\u00e8tement ouvert sur tout le r\u00e9seau PfSense : L'interface public est configur\u00e9e pour laisser passer le traffic OpenVPN entrant en UDP sur le port 1194 : Cr\u00e9ation des utilisateurs La cr\u00e9ation ainsi que la suppression des clients se fait via un script python qui requ\u00eate sur l'API de PfSense. Se r\u00e9f\u00e9rer \u00e0 la documentation li\u00e9e. Configuration des clients Dans un premier temps, il faut t\u00e9l\u00e9charger le client OpenVPN : Pour Linux : Lien Pour MacOS : Lien Pour Windows : Lien Ensuite, il suffit d'installer le client, puis de proc\u00e9der \u00e0 la configuration du tunnel. Windows Ouvrir l'application OpenVPN : Importer le fichier de configuration ovpn fourni : S'identifier pour la connexion avec l'identifiant fourni ainsi que le mot de passe : Activer la connecion : REST API Pour l'installation, suivre les instructions de la documentation suivante. Gestion DNS Pour g\u00e9rer les r\u00e9solutions DNS du router PfSense, un script a \u00e9t\u00e9 \u00e9crit pour permettre \u00e0 tous de pouvoir disposer de la possibilit\u00e9 d'\u00e9diter ses propres r\u00e9solutions. Ce script permet : Lister toutes les entr\u00e9es DNS sur serveur PfSense Contr\u00f4ler si une entr\u00e9e (IP ou Hostname) est pr\u00e9sente dans la base de donn\u00e9es de PfSense. Ajouter une enr\u00e9e DNS Supprimer une entr\u00e9e DNS D\u00e9pendances : os requests urllib3 click json Pour satisfaire les d\u00e9pendances : pip install .. L'outil est tr\u00e8s simple d'utilisation. Example S'assurer que l'IP 10.0.2.10 n'a pas de r\u00e9solution DNS qui pointe dessus : \u276f python3 dns.py check -n dev-01 No match S'il y a match, alors les entr\u00e9es concern\u00e9es seront affich\u00e9es : \u276f python3 dns.py check -i 10 .0.0.2 +----+---------+------------+----------+---------------------+ | ID | Host | Domain | IP | Description | +----+---------+------------+----------+---------------------+ | 6 | proxmox | infra.aosc | 10 .0.0.2 | Hyperviseur Proxmox | | 9 | sandbox | infra.aosc | 10 .0.0.2 | Hyperviseur Proxmox | +----+---------+------------+----------+---------------------+ Puis cr\u00e9er un nouvel enregistrement : \u276f python3 dns.py create -i 10 .0.2.21 -d casio.aosc -n dev-01 -c \"Talos control-plane 1\" Request: Success Dans le cas ou le hostname ainsi que le domaine de la nouvelle entr\u00e9e existerai d\u00e9j\u00e0, le processus de cr\u00e9ation se stoppera pour ne pas cr\u00e9er de doubles entr\u00e9es. Si besoin d'une suppression, il suffit de r\u00e9cup\u00e9rer l'identifiant de l'alias pour le supprimer : \u276f python3 dns.py remove 6 Request: Success Pour r\u00e9cup\u00e9rer l'identifiant, il suffit de checker l'alias ou afficher la base de donn\u00e9es enti\u00e8re : \u276f python3 dns.py show +----+----------------+------------+-----------+--------------------------------------+ | ID | Host | Domain | IP | Description | +----+----------------+------------+-----------+--------------------------------------+ | 0 | casio-master-1 | casio.aosc | 10 .0.2.11 | casio talos master 1 | | 1 | casio-master-2 | casio.aosc | 10 .0.2.12 | casio talos master 2 | | 2 | casio-master-3 | casio.aosc | 10 .0.2.13 | casio talos master 3 | | 3 | casio-worker-1 | casio.aosc | 10 .0.2.14 | casio talos worker 1 | | 4 | casio-worker-2 | casio.aosc | 10 .0.2.15 | casio talos worker 2 | | 5 | casio-worker-3 | casio.aosc | 10 .0.2.16 | casio talos worker 3 | | 6 | proxmox | infra.aosc | 10 .0.0.2 | Hyperviseur Proxmox | | 7 | router | infra.aosc | 10 .0.0.1 | Router principale de l 'infrastruture | | 8 | rt | infra.aosc | 10.0.0.1 | Router principale de l' infrastruture | | 9 | sandbox | infra.aosc | 10 .0.0.2 | Hyperviseur Proxmox | +----+----------------+------------+-----------+--------------------------------------+ En cas de probl\u00e8me dans l'utilisation de l'outil, se r\u00e9f\u00e9rer au manuel. Example Affichage de l'aide : \u276f python3 dns.py --help Usage: dns.py [ OPTIONS ] COMMAND [ ARGS ] ... Manage the PfSense DNS Options: --help Show this message and exit. Commands: check Check availibility of a new alias create Create a new alias remove Remove an alias by its row ID show List all alias version Print script version Affichage de l'aide des sous commandes : \u276f python3 dns.py check --help Usage: dns.py check [ OPTIONS ] FIELD Check availibility of a new alias Options: -i, --ip Required to check an IP -n, --name Required to check an Hostname --help Show this message and exit. Gestion des utilisateurs Pour g\u00e9rer les utilisateurs du router PfSense, un script a \u00e9t\u00e9 \u00e9crit pour permettre \u00e0 tous de pouvoir disposer de la possibilit\u00e9 d'\u00e9diter ses propres r\u00e9solutions. Ce script permet : Lister toutes les utilisateurs du serveur PfSense Contr\u00f4ler si un utilisateur est pr\u00e9sent ou pas Ajouter un utilisateur Supprimer un utilisateur D\u00e9pendances : os requests urllib3 click json Pour satisfaire les d\u00e9pendances : pip install .. L'outil est tr\u00e8s simple d'utilisation. Example Afficher tous les utilisateurs : +----+------+--------+----------------------+------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | ID | UID | Nom | Description | Expiration | Cl\u00e9 publique SSH | +----+------+--------+----------------------+------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | 0 | 0 | admin | System Administrator | | ZWNkc2Etc2hhMi1uaXN0cDI1NiBBQUFBRTJWalpITmhMWE5vWVRJdGJtbHpkSEF5TlRZQUFBQUlibWx6ZEhBeU5UWUFBQUJCQklUWE1RQXI5dDNNaEcyTS8wVFBFdlhiS2VUYnZ6RzlCVlVxS2ZMY1hSa1BVSk9Wc2s0QlF4eTVXT1BnMTZ0d3U5ZFpMQytFZDlwdnREN05XL2NNeSswPSBidXJkQHRoZW5lc3Q = | | 1 | 2000 | nbecu | Nicolas Becu | | ZWNkc2Etc2hhMi1uaXN0cDI1NiBBQUFBRTJWalpITmhMWE5vWVRJdGJtbHpkSEF5TlRZQUFBQUlibWx6ZEhBeU5UWUFBQUJCQklUWE1RQXI5dDNNaEcyTS8wVFBFdlhiS2VUYnZ6RzlCVlVxS2ZMY1hSa1BVSk9Wc2s0QlF4eTVXT1BnMTZ0d3U5ZFpMQytFZDlwdnREN05XL2NNeSswPSBidXJkQHRoZW5lc3Q = | | 2 | 2001 | runner | runner ansible | | ZWNkc2Etc2hhMi1uaXN0cDI1NiBBQUFBRTJWalpITmhMWE5vWVRJdGJtbHpkSEF5TlRZQUFBQUlibWx6ZEhBeU5UWUFBQUJCQklUWE1RQXI5dDNNaEcyTS8wVFBFdlhiS2VUYnZ6RzlCVlVxS2ZMY1hSa1BVSk9Wc2s0QlF4eTVXT1BnMTZ0d3U5ZFpMQytFZDlwdnREN05XL2NNeSswPSBidXJkQHRoZW5lc3Q = | +----+------+--------+----------------------+------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ Controller la pr\u00e9sence d'un utilisateur : \u276f python3 user.py check jallen No match Ajouter un utilisateur : \u276f python3 user.py create -n \"jallen\" -p \"Not@Password\" -d \"John Allen\" -k \"SshPublicKey\" Request: Success \u276f python3 user.py check jallen +----+------+--------+-------------+------------+------------------+ | ID | UID | Nom | Description | Expiration | Cl\u00e9 publique SSH | +----+------+--------+-------------+------------+------------------+ | 3 | 2009 | jallen | John Allen | 01 /01/2100 | U3NoUHVibGljS2V5 | +----+------+--------+-------------+------------+------------------+ Supprimer un utilisateur : \u276f python3 user.py remove jallen Request: Success \u276f python3 user.py check jallen No match Afficher l'aide : \u276f python3 user.py --help Usage: user.py [ OPTIONS ] COMMAND [ ARGS ] ... Manage the PfSense DNS Options: --help Show this message and exit. Commands: check Check availibility of a new alias create Create a new alias remove Remove an alias by its row ID show List all alias version Print script version Afficher l'aide d'une commande : \u276f python3 user.py create --help Usage: user.py create [ OPTIONS ] Create a new alias Options: -n, --name TEXT identifier of the new user [ required ] -p, --password TEXT Password of the new user [ required ] -d, --description TEXT Firstname and Lastname of the new user [ required ] -k, --key TEXT SSH public key of the new user [ required ] --help Show this message and exit.","title":"PfSense documentation"},{"location":"pfsense/#pfsense","text":"","title":"PfSense"},{"location":"pfsense/#ovh","text":"La machine virtuelle PfSense dispose d'un acc\u00e8s internet gr\u00e2ce \u00e0 un routage interne au serveur d\u00e9di\u00e9 lui permettant d'\u00eatre rattach\u00e9 \u00e0 une IP FailOver.","title":"OVH"},{"location":"pfsense/#console-web-ovh","text":"Une fois connecter \u00e0 la console web d'OVH, il faut se rendre dans la section bare metal cloud et d\u00e9rouler l'onglet des serveurs d\u00e9di\u00e9s pour pouvoir choisir celui d\u00e9sir\u00e9 : Dans l'onglet de gestion des interfaces r\u00e9seaux, on ouvre la console de gestion des adresses IP du serveur : On d\u00e9place l'adresse IP sur le serveur d\u00e9sir\u00e9 : Pour finir, on ajoute une adresse MAC virtuelle \u00e0 l'adresse IP, ce qui permettra de router le traffic r\u00e9seau sur la machine virtuelle poss\u00e9dant cette adresse MAC.","title":"Console web OVH"},{"location":"pfsense/#configuration-de-la-machine-virtuelle","text":"On commence par configurer l'interface r\u00e9seau vmbr0 du Proxmox . Celle doit \u00eatre configur\u00e9e en static sur l'adresse public du serveur. Sa passerelle r\u00e9seau doit imp\u00e9rativement \u00eatre configur\u00e9e. Tip La configuration r\u00e9seau de l'interface principale de Proxmox est effectu\u00e9e par l'installeur. Il n'est normalement pas n\u00e9cessaire d'y toucher. Info Les r\u00e9seau OVH ont tous une passerelle en 254 . Pour conna\u00eetre sa passerelle, il suffit de prendre les 3 premiers octets de l'adresse du serveur, puis de compl\u00e9ter le dernier octet par 254 . Ensuite, on ajoute \u00e0 la machine virtuelle PfSense son interface WAN , en lui attribuant l'adresse MAC virtuelle de l'IP FailOver qui a \u00e9t\u00e9 configur\u00e9e au pr\u00e9alable. Dans l'interface web d'administration de pfsense, on configure la passerelle par d\u00e9faut qui sera utilis\u00e9e pour le routage de tout le traffic r\u00e9seau entrant et sortant. Puis on param\u00e8tre PfSense pour pointer dessus. Dans l'interface web d'administration de pfsense, on configure l'interface r\u00e9seau WAN .","title":"Configuration de la machine virtuelle"},{"location":"pfsense/#gestion-du-reseau","text":"","title":"Gestion du r\u00e9seau"},{"location":"pfsense/#interfaces-reseaux","text":"Chaque nouvelle interface r\u00e9seau attach\u00e9e \u00e0 la machine virtuelle PfSense est instantan\u00e9ment visible dans l'interface d'aministration du routeur : Une fois la nouvelle interface ajout\u00e9e \u00e0 la gestion de PfSense, il reste \u00e0 faire la configuration de cette interface, tout en s'assurant qu'elle soit activ\u00e9e :","title":"Interfaces r\u00e9seaux"},{"location":"pfsense/#serveur-dhcp","text":"Chaque interface \u00e0 la possibilit\u00e9 de disposer de son propre server DHCP","title":"Serveur DHCP"},{"location":"pfsense/#serveur-dns","text":"PfSense dispose de son propre r\u00e9solver DNS bas\u00e9 sur Unbound . Il r\u00e9cup\u00e8re sa r\u00e9solution publique aupr\u00e8s des serveurs DNS de CloudFlare : Il est \u00e9galement possible de rajouter des entr\u00e9es personnalis\u00e9es dans la r\u00e9solution locale :","title":"Serveur DNS"},{"location":"pfsense/#routage-interne","text":"Le routeur laisse passer sur son interface publique : Le protocole ICMP : Pour permettre le ping du routeur \u00e0 des fin surtout d'administration Le protocole SSH sur le port 2222 : Pour permettre d'acc\u00e9der en shell au routeur Le protocole UDP sur le port de WIREGUARD (51820) : Pour permettre un acc\u00e8s VPN au uilisateurs Info Des r\u00e8gles d'acc\u00e8s pour les protocoles HTTP et HTTPS sont \u00e9galement en place mais d\u00e9sactiv\u00e9es par mesure de s\u00e9curit\u00e9. Elle peuvent \u00eatre r\u00e9activ\u00e9es sur demande si besoin est (maintenance, incident, etc.) Le r\u00e9seau principale (default) est totalement ouvert sur tous le r\u00e9seau interne g\u00e9r\u00e9 par PfSense : Pour des besoins sp\u00e9cifiques, il est \u00e9galement possible de cr\u00e9er des routage restrictifs sur le traffic inter-r\u00e9seau. Comme on peut le voir sur la capture suivante, le r\u00e9seau peut communiquer avec le routeur ou avec internet. Il peut \u00e9galement communiquer avec le r\u00e9seau li\u00e9 \u00e0 Wireguard (le VPN), mais aucun autre r\u00e9seau, pas m\u00eame le d\u00e9fault ne peuvent communiquer avec lui.","title":"Routage interne"},{"location":"pfsense/#gestion-des-acces","text":"Note D\u00e9finir une strat\u00e9gie d'acc\u00e8s au PfSense","title":"Gestion des acc\u00e8s"},{"location":"pfsense/#acces-ssh","text":"Chaque compte cr\u00e9\u00e9 dans le cadre d'un acc\u00e8s VPN OpenVPN se voit attribuer la possibilit\u00e9 de se connecter en shell sur le PfSense. Cela permet si besoin aux collaborateurs de faire du ProxyJump SSH si besoin (\u00e9viter d'initialiser une connexion VPN pour se connecter \u00e0 une machine virtuelle).","title":"Acc\u00e8s SSH"},{"location":"pfsense/#acces-web-internes","text":"Les acc\u00e8s web interne se font via tunnel VPN. Pour PfSense, celui ci est accessible via le domain rt.infra.aosc , ou via toute les adresses passerelles de r\u00e9seaux. Pour tout acc\u00e8s web \u00e0 une un service h\u00e9berg\u00e9 sur une machine virtuelle, il suffit d'y acc\u00e9der par son adresse IP.","title":"Acc\u00e8s web internes"},{"location":"pfsense/#acces-web-public","text":"Les acc\u00e8s web publics \u00e0 PfSense sont d\u00e9sactiv\u00e9s au niveau pare feu. Ils peuvent \u00eatre r\u00e9activ\u00e9s sur besoin en cas de probl\u00e8mes r\u00e9seaux. Pour les expositions de services herberg\u00e9s sur la sandbox, il n'est \u00e0 ce jour pas pr\u00e9vu d'exposer ces services (via reverse proxy par exemple). Les acc\u00e8s devront se faire par tunnel VPN.","title":"Acc\u00e8s web public"},{"location":"pfsense/#wireguard","text":"PfSense fourni un acc\u00e8s VPN (Virtual Private Network) au r\u00e9seau interne de l'hyperviseur Proxmox .","title":"Wireguard"},{"location":"pfsense/#installation-du-client","text":"Wireguard est disponible sur \u00e9norm\u00e9ment de plateformes. Pour les instructions d'installation, se r\u00e9f\u00e9rer \u00e0 la documentation officielle","title":"Installation du client"},{"location":"pfsense/#gestion-des-cles-chriffrees","text":"Wireguard n\u00e9cessite l'utilisation de cl\u00e9 chifr\u00e9es priv\u00e9es et publiques. Cr\u00e9er une paire de cl\u00e9s chifr\u00e9es : wg genkey | tee privatekey | wg pubkey > publickey Il est \u00e9galement possible de se rendre sur ce site , g\u00e9n\u00e9rer une configuration al\u00e9atoire pour r\u00e9cup\u00e9rer la cl\u00e9 public et priv\u00e9e. Dans le cas o\u00f9 vous voudriez garder ces cl\u00e9s, il faudra les d\u00e9placer en lieu s\u00fbr. Dans le cas contraire, il suffit de les supprimer car plus utile.","title":"Gestion des cl\u00e9s chriffr\u00e9es"},{"location":"pfsense/#configuration-du-client","text":"La m\u00e9thode la plus simple est d'utiliser un fichier de configuration. [Interface] : Configure la configuration locale Address : Adresse ip (avec CIDR ) de l'utilisateur PrivateKey : Cl\u00e9 chifr\u00e9e priv\u00e9e de l'utilisateur DNS : Serveur DNS de r\u00e9f\u00e9rence un fois connct\u00e9. [Peer] : PublicKey : Cl\u00e9 chifr\u00e9e publique du serveur distant Endpoint : Adresse / Domaine du serveur distant avec son port (ex: ip:port ) AllowedIPs : R\u00e9seaux autoris\u00e9s (Pour faire passer tous le traffic \u00e0 travers la connexion: 0.0.0.0/0) PersistentKeepalive : Persistence de la connexion en secondes Pour exemple, avec le fichier aosc.conf : [Interface] Address = 10.0.1.x/32 PrivateKey = DNS = 10.0.0.1 [Peer] PublicKey = Endpoint = rt.aosc-portal.com:51820 AllowedIPs = 0.0.0.0/0 PersistentKeepalive = 30","title":"Configuration du client"},{"location":"pfsense/#connexion-du-client","text":"","title":"Connexion du client"},{"location":"pfsense/#linux","text":"Placez le fichier de configuration wireguard \u00e0 l'emplacement suivant : /etc/wireguard/aosc.conf Caution Ne pas utiliser de caract\u00e8re sp\u00e9ciaux dans le nommage du fichier. Les interface virtuelle verra leur nom bas\u00e9 sur ce fichier, cela pourrait donc faire disfonctionner le processus de connexion. Activation du tunnel VPN sudo wg-quick up aosc Affichage du statut de la connexion sudo wg D\u00e9sactivation du tunnel VPN sudo wg-quick down aosc Info Pour une configuration automatique de la r\u00e9solution DNS sur Linux , le paquet resolvconf doit \u00eatre pr\u00e9sent sur le system. Le fichier /etc/resolv.conf se doit d'\u00eatre un lien symbolique du fichier /run/resolvconf/resolv.conf . Dans le cas contraire le changement de serveur DNS du syst\u00e8me devra se faire manuellement.","title":"Linux"},{"location":"pfsense/#windows","text":"Ouvrir le gestion de connexion Wireguard Importer la connexion \u00e0 partir d'un fichier de configuration V\u00e9rifier les informations de la nouvelle connexion Activer la connexion","title":"Windows"},{"location":"pfsense/#macos","text":"Ouvrir le gestionnaire de tunnel Wireguard : Choisir un fichier \u00e0 importer : V\u00e9rifier les informations : Activer la connexion :","title":"MacOS"},{"location":"pfsense/#android","text":"R\u00e9cup\u00e9rer l'application wireguard sur le play store Ajouter une nouvelle connexion \u00e0 partir d'un fichier Activer la connexion Tip Il est possible de conrt\u00f4ller la connexion avec un simple ping","title":"Android"},{"location":"pfsense/#integration-a-pfsense","text":"Wireguard est int\u00e9gr\u00e9 aux d\u00e9p\u00f4ts officiels de PfSense. Ainsi, son installation se fait par le gestionnaire de paquets de la solution logicielle. Tout d'abord, chercher le paquet : Ensuite, l'installer :","title":"Int\u00e9gration \u00e0 PfSense"},{"location":"pfsense/#configuration-du-serveur","text":"Pour configurer un tunnel VPN, il suffit de se rendre dans l'onglet de configuration de Wireguard : Puis, on cr\u00e9er un nouveau tunnel :","title":"Configuration du serveur"},{"location":"pfsense/#configuration-des-utilisateurs","text":"Pour configurer un nouvel utilisateur, il suffit de se rendre dans l'onglet de Peer : Puis, on ajoute une nouvel connexion :","title":"Configuration des utilisateurs"},{"location":"pfsense/#gestion-des-routes","text":"Le r\u00e9seau Wireguard a acc\u00e8s \u00e0 l'enti\u00e8ret\u00e9 du r\u00e9seau interne : Il est \u00e9galement autoris\u00e9 \u00e0 sortir sur internet :","title":"Gestion des routes"},{"location":"pfsense/#openvpn","text":"","title":"OpenVPN"},{"location":"pfsense/#installation","text":"Le paquet OpenVPN est inclus nativement dans PfSense, il n'y a donc pas d'installation particuli\u00e8re \u00e0 faire.","title":"Installation"},{"location":"pfsense/#configuration","text":"Tout d'abord, il faut cr\u00e9er le certificat d'autorit\u00e9 qui sera utilis\u00e9 par le serveur OpenVPN : Ensuite vient la cr\u00e9ation du certificat server sign\u00e9 par le certification d'authorit\u00e9 qui sera utilis\u00e9 par le serveur OpenVPN : Pour finir, il faut cr\u00e9er le server OpenVPN :","title":"Configuration"},{"location":"pfsense/#routage","text":"Le routage du r\u00e9seau virtuelle du serveur OpenVPN est compl\u00e8tement ouvert sur tout le r\u00e9seau PfSense : L'interface public est configur\u00e9e pour laisser passer le traffic OpenVPN entrant en UDP sur le port 1194 :","title":"Routage"},{"location":"pfsense/#creation-des-utilisateurs","text":"La cr\u00e9ation ainsi que la suppression des clients se fait via un script python qui requ\u00eate sur l'API de PfSense. Se r\u00e9f\u00e9rer \u00e0 la documentation li\u00e9e.","title":"Cr\u00e9ation des utilisateurs"},{"location":"pfsense/#configuration-des-clients","text":"Dans un premier temps, il faut t\u00e9l\u00e9charger le client OpenVPN : Pour Linux : Lien Pour MacOS : Lien Pour Windows : Lien Ensuite, il suffit d'installer le client, puis de proc\u00e9der \u00e0 la configuration du tunnel.","title":"Configuration des clients"},{"location":"pfsense/#windows_1","text":"Ouvrir l'application OpenVPN : Importer le fichier de configuration ovpn fourni : S'identifier pour la connexion avec l'identifiant fourni ainsi que le mot de passe : Activer la connecion :","title":"Windows"},{"location":"pfsense/#rest-api","text":"Pour l'installation, suivre les instructions de la documentation suivante.","title":"REST API"},{"location":"pfsense/#gestion-dns","text":"Pour g\u00e9rer les r\u00e9solutions DNS du router PfSense, un script a \u00e9t\u00e9 \u00e9crit pour permettre \u00e0 tous de pouvoir disposer de la possibilit\u00e9 d'\u00e9diter ses propres r\u00e9solutions. Ce script permet : Lister toutes les entr\u00e9es DNS sur serveur PfSense Contr\u00f4ler si une entr\u00e9e (IP ou Hostname) est pr\u00e9sente dans la base de donn\u00e9es de PfSense. Ajouter une enr\u00e9e DNS Supprimer une entr\u00e9e DNS D\u00e9pendances : os requests urllib3 click json Pour satisfaire les d\u00e9pendances : pip install .. L'outil est tr\u00e8s simple d'utilisation. Example S'assurer que l'IP 10.0.2.10 n'a pas de r\u00e9solution DNS qui pointe dessus : \u276f python3 dns.py check -n dev-01 No match S'il y a match, alors les entr\u00e9es concern\u00e9es seront affich\u00e9es : \u276f python3 dns.py check -i 10 .0.0.2 +----+---------+------------+----------+---------------------+ | ID | Host | Domain | IP | Description | +----+---------+------------+----------+---------------------+ | 6 | proxmox | infra.aosc | 10 .0.0.2 | Hyperviseur Proxmox | | 9 | sandbox | infra.aosc | 10 .0.0.2 | Hyperviseur Proxmox | +----+---------+------------+----------+---------------------+ Puis cr\u00e9er un nouvel enregistrement : \u276f python3 dns.py create -i 10 .0.2.21 -d casio.aosc -n dev-01 -c \"Talos control-plane 1\" Request: Success Dans le cas ou le hostname ainsi que le domaine de la nouvelle entr\u00e9e existerai d\u00e9j\u00e0, le processus de cr\u00e9ation se stoppera pour ne pas cr\u00e9er de doubles entr\u00e9es. Si besoin d'une suppression, il suffit de r\u00e9cup\u00e9rer l'identifiant de l'alias pour le supprimer : \u276f python3 dns.py remove 6 Request: Success Pour r\u00e9cup\u00e9rer l'identifiant, il suffit de checker l'alias ou afficher la base de donn\u00e9es enti\u00e8re : \u276f python3 dns.py show +----+----------------+------------+-----------+--------------------------------------+ | ID | Host | Domain | IP | Description | +----+----------------+------------+-----------+--------------------------------------+ | 0 | casio-master-1 | casio.aosc | 10 .0.2.11 | casio talos master 1 | | 1 | casio-master-2 | casio.aosc | 10 .0.2.12 | casio talos master 2 | | 2 | casio-master-3 | casio.aosc | 10 .0.2.13 | casio talos master 3 | | 3 | casio-worker-1 | casio.aosc | 10 .0.2.14 | casio talos worker 1 | | 4 | casio-worker-2 | casio.aosc | 10 .0.2.15 | casio talos worker 2 | | 5 | casio-worker-3 | casio.aosc | 10 .0.2.16 | casio talos worker 3 | | 6 | proxmox | infra.aosc | 10 .0.0.2 | Hyperviseur Proxmox | | 7 | router | infra.aosc | 10 .0.0.1 | Router principale de l 'infrastruture | | 8 | rt | infra.aosc | 10.0.0.1 | Router principale de l' infrastruture | | 9 | sandbox | infra.aosc | 10 .0.0.2 | Hyperviseur Proxmox | +----+----------------+------------+-----------+--------------------------------------+ En cas de probl\u00e8me dans l'utilisation de l'outil, se r\u00e9f\u00e9rer au manuel. Example Affichage de l'aide : \u276f python3 dns.py --help Usage: dns.py [ OPTIONS ] COMMAND [ ARGS ] ... Manage the PfSense DNS Options: --help Show this message and exit. Commands: check Check availibility of a new alias create Create a new alias remove Remove an alias by its row ID show List all alias version Print script version Affichage de l'aide des sous commandes : \u276f python3 dns.py check --help Usage: dns.py check [ OPTIONS ] FIELD Check availibility of a new alias Options: -i, --ip Required to check an IP -n, --name Required to check an Hostname --help Show this message and exit.","title":"Gestion DNS"},{"location":"pfsense/#gestion-des-utilisateurs","text":"Pour g\u00e9rer les utilisateurs du router PfSense, un script a \u00e9t\u00e9 \u00e9crit pour permettre \u00e0 tous de pouvoir disposer de la possibilit\u00e9 d'\u00e9diter ses propres r\u00e9solutions. Ce script permet : Lister toutes les utilisateurs du serveur PfSense Contr\u00f4ler si un utilisateur est pr\u00e9sent ou pas Ajouter un utilisateur Supprimer un utilisateur D\u00e9pendances : os requests urllib3 click json Pour satisfaire les d\u00e9pendances : pip install .. L'outil est tr\u00e8s simple d'utilisation. Example Afficher tous les utilisateurs : +----+------+--------+----------------------+------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | ID | UID | Nom | Description | Expiration | Cl\u00e9 publique SSH | +----+------+--------+----------------------+------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | 0 | 0 | admin | System Administrator | | ZWNkc2Etc2hhMi1uaXN0cDI1NiBBQUFBRTJWalpITmhMWE5vWVRJdGJtbHpkSEF5TlRZQUFBQUlibWx6ZEhBeU5UWUFBQUJCQklUWE1RQXI5dDNNaEcyTS8wVFBFdlhiS2VUYnZ6RzlCVlVxS2ZMY1hSa1BVSk9Wc2s0QlF4eTVXT1BnMTZ0d3U5ZFpMQytFZDlwdnREN05XL2NNeSswPSBidXJkQHRoZW5lc3Q = | | 1 | 2000 | nbecu | Nicolas Becu | | ZWNkc2Etc2hhMi1uaXN0cDI1NiBBQUFBRTJWalpITmhMWE5vWVRJdGJtbHpkSEF5TlRZQUFBQUlibWx6ZEhBeU5UWUFBQUJCQklUWE1RQXI5dDNNaEcyTS8wVFBFdlhiS2VUYnZ6RzlCVlVxS2ZMY1hSa1BVSk9Wc2s0QlF4eTVXT1BnMTZ0d3U5ZFpMQytFZDlwdnREN05XL2NNeSswPSBidXJkQHRoZW5lc3Q = | | 2 | 2001 | runner | runner ansible | | ZWNkc2Etc2hhMi1uaXN0cDI1NiBBQUFBRTJWalpITmhMWE5vWVRJdGJtbHpkSEF5TlRZQUFBQUlibWx6ZEhBeU5UWUFBQUJCQklUWE1RQXI5dDNNaEcyTS8wVFBFdlhiS2VUYnZ6RzlCVlVxS2ZMY1hSa1BVSk9Wc2s0QlF4eTVXT1BnMTZ0d3U5ZFpMQytFZDlwdnREN05XL2NNeSswPSBidXJkQHRoZW5lc3Q = | +----+------+--------+----------------------+------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ Controller la pr\u00e9sence d'un utilisateur : \u276f python3 user.py check jallen No match Ajouter un utilisateur : \u276f python3 user.py create -n \"jallen\" -p \"Not@Password\" -d \"John Allen\" -k \"SshPublicKey\" Request: Success \u276f python3 user.py check jallen +----+------+--------+-------------+------------+------------------+ | ID | UID | Nom | Description | Expiration | Cl\u00e9 publique SSH | +----+------+--------+-------------+------------+------------------+ | 3 | 2009 | jallen | John Allen | 01 /01/2100 | U3NoUHVibGljS2V5 | +----+------+--------+-------------+------------+------------------+ Supprimer un utilisateur : \u276f python3 user.py remove jallen Request: Success \u276f python3 user.py check jallen No match Afficher l'aide : \u276f python3 user.py --help Usage: user.py [ OPTIONS ] COMMAND [ ARGS ] ... Manage the PfSense DNS Options: --help Show this message and exit. Commands: check Check availibility of a new alias create Create a new alias remove Remove an alias by its row ID show List all alias version Print script version Afficher l'aide d'une commande : \u276f python3 user.py create --help Usage: user.py create [ OPTIONS ] Create a new alias Options: -n, --name TEXT identifier of the new user [ required ] -p, --password TEXT Password of the new user [ required ] -d, --description TEXT Firstname and Lastname of the new user [ required ] -k, --key TEXT SSH public key of the new user [ required ] --help Show this message and exit.","title":"Gestion des utilisateurs"},{"location":"proxmox/","text":"Proxmox Installation L'installation se fait par le biais de la console web OVH. Le processus est automatis\u00e9 et guid\u00e9. Le stockage Le stockage du serveur Proxmox est g\u00e9r\u00e9 par le syst\u00e8me de fichier ZFS . C'est celui ci qui g\u00e8re le RAID des disques physiques en un seul et m\u00eame Pool ZFS . zpool status Done pool: zp0 state: ONLINE status: Some supported and requested features are not enabled on the pool. The pool can still be used, but some features are unavailable. action: Enable all features using 'zpool upgrade'. Once this is done, the pool may no longer be accessible by software that does not support the features. See zpool-features(7) for details. scan: scrub repaired 0B in 00:06:53 with 0 errors on Sun Sep 11 00:30:55 2022 config: NAME STATE READ WRITE CKSUM zp0 ONLINE 0 0 0 sda2 ONLINE 0 0 0 errors: No known data errors Le Pool ZFS est d\u00e9coup\u00e9 en plusieurs syst\u00e8mes de fichiers ZFS : zp0/zd0 : La partition de boot zp0/zd1 : La partition syst\u00e8me zp0/zd2 :Le stockage de l'hyperviseur zfs list Done NAME USED AVAIL REFER MOUNTPOINT zp0 65.6G 7.08T 96K none zp0/zd0 173M 851M 173M legacy zp0/zd1 3.92G 44.9G 3.92G legacy zp0/zd2 61.4G 7.08T 61.4G legacy Les r\u00e9seaux Si besoin, des r\u00e9seaux priv\u00e9s peuvent \u00eatre cr\u00e9\u00e9s. Pour cela, on se d\u00e9place dans l'onglet de gestion du r\u00e9seau de Proxmox : Puis un cr\u00e9\u00e9 une nouvelle interface r\u00e9seau virtuelle ( Linux Bridge ) : Info Dans la section commentaire, on renseignera le pool auquel cette interface est li\u00e9e ainsi que le r\u00e9seau pr\u00e9sent sur cette interface pour aider les utilisateurs lors de l'affectation d'un r\u00e9seau \u00e0 une machine virtuelle. Pour finir, on ajoute la nouvelle interface au PfSense : Lors de la cr\u00e9ation ou de la re configuration d'une machine virtuelle, il suffira de choisir le r\u00e9seau souhait\u00e9 : Pour les d\u00e9tails concernants la configuration c\u00f4t\u00e9 PfSense , se r\u00e9f\u00e9rer \u00e0 la documentation li\u00e9e. Gestion des acc\u00e8s Les utilisateurs Pour cr\u00e9er un utilisateur on se rend dans la rubrique des gestion des utilisateurs : Puis on cr\u00e9\u00e9 un nouvel utilisateur : Tip Il existe deux mode d'authentification dans proxmox : La premi\u00e8re est la PAM qui est h\u00e9rit\u00e9e de l'authentification Linux . La seconde est la PVE qui est l'authentification relative \u00e0 Proxmox . Dans le premier cas, l'authentification se trouve au niveau du serveur, et un acc\u00e8s au shell notamment SSH est possible. Dans le second cas, l'authentification n'est valide qu'au niveau applicatif (WebUI Proxmox). Info Les comptes PAM seront d\u00e9livr\u00e9s aux collaborateurs succeptibles de participer \u00e0 la maintenance de l'hyperviseur ou \u00e0 intervenir dessus en cas de probl\u00e8mes. Les groups Il existe plusieurs groupes correspondant au diff\u00e9rents projets : Admin Operator Default Support Casio Ces groupes correspondent aux diff\u00e9rentes activit\u00e9s sur l'hyperviseur. Les pools Les pools regroupent les machines virtuelles par projets ou par utilisation. Chaque Pool dispose d'une restriction d'acc\u00e8s ne permettant qu'aux utilisateur faisant parti du groupe correspondant d'avoir acc\u00e8s aux ressources pr\u00e9sentes dans le Pool. Authentification double facteur Pour activer l'authentification multi facteur, il suffit de d\u00e9rouler le menu utilisateur en haut \u00e0 droite de l'interface web puis de s\u00e9lectionner le TFA. Cela aura pour effet de rediriger sur l'interface de gestion des TFA. Il suffit ensuite de s\u00e9lectionner son utilisateur puis de cliquer sur ajouter pour configurer l'acc\u00e8s. Copiez le secret dans votre application de gestion de jetons puis renseignez le code g\u00e9n\u00e9r\u00e9 par l'application ainsi que le mot de passe du compte pour valider la configuration du TFA. Probl\u00e8mes connus Une des mise \u00e0 jour du noyau du syst\u00e8me a r\u00e9ussi \u00e0 casser le programme de d\u00e9marrage ( GRUB ). Le serveur a donc red\u00e9marr\u00e9 en mode urgence. Dans le shell BusyBox , il a suffit d'importer \u00e0 nouveau le pool ZFS qui \u00e9tait vu comme appartenant \u00e0 un autre syst\u00e8me. En IPMI , ex\u00e9cuter la commande suivante : zpool import -f zp0 Pour finir, toujours en IPMI , \u00e9teindre le serveur, puis le red\u00e9marrer et attendre qu'il d\u00e9marre correctement. Gestion de la virtualisation Gestion des images ISO Illustration de l'ajout d'une image ISO au d\u00e9p\u00f4t : T\u00e9l\u00e9charger une ISO depuis une url avec le bouton Download. (droits administrateurs requis) T\u00e9l\u00e9charger une ISO depuis sa machine avec le bouton Upload. Supprimer une ISO en la s\u00e9lectionnant puis cliquer sur Supprimer.","title":"Proxmox documentation"},{"location":"proxmox/#proxmox","text":"","title":"Proxmox"},{"location":"proxmox/#installation","text":"L'installation se fait par le biais de la console web OVH. Le processus est automatis\u00e9 et guid\u00e9.","title":"Installation"},{"location":"proxmox/#le-stockage","text":"Le stockage du serveur Proxmox est g\u00e9r\u00e9 par le syst\u00e8me de fichier ZFS . C'est celui ci qui g\u00e8re le RAID des disques physiques en un seul et m\u00eame Pool ZFS . zpool status Done pool: zp0 state: ONLINE status: Some supported and requested features are not enabled on the pool. The pool can still be used, but some features are unavailable. action: Enable all features using 'zpool upgrade'. Once this is done, the pool may no longer be accessible by software that does not support the features. See zpool-features(7) for details. scan: scrub repaired 0B in 00:06:53 with 0 errors on Sun Sep 11 00:30:55 2022 config: NAME STATE READ WRITE CKSUM zp0 ONLINE 0 0 0 sda2 ONLINE 0 0 0 errors: No known data errors Le Pool ZFS est d\u00e9coup\u00e9 en plusieurs syst\u00e8mes de fichiers ZFS : zp0/zd0 : La partition de boot zp0/zd1 : La partition syst\u00e8me zp0/zd2 :Le stockage de l'hyperviseur zfs list Done NAME USED AVAIL REFER MOUNTPOINT zp0 65.6G 7.08T 96K none zp0/zd0 173M 851M 173M legacy zp0/zd1 3.92G 44.9G 3.92G legacy zp0/zd2 61.4G 7.08T 61.4G legacy","title":"Le stockage"},{"location":"proxmox/#les-reseaux","text":"Si besoin, des r\u00e9seaux priv\u00e9s peuvent \u00eatre cr\u00e9\u00e9s. Pour cela, on se d\u00e9place dans l'onglet de gestion du r\u00e9seau de Proxmox : Puis un cr\u00e9\u00e9 une nouvelle interface r\u00e9seau virtuelle ( Linux Bridge ) : Info Dans la section commentaire, on renseignera le pool auquel cette interface est li\u00e9e ainsi que le r\u00e9seau pr\u00e9sent sur cette interface pour aider les utilisateurs lors de l'affectation d'un r\u00e9seau \u00e0 une machine virtuelle. Pour finir, on ajoute la nouvelle interface au PfSense : Lors de la cr\u00e9ation ou de la re configuration d'une machine virtuelle, il suffira de choisir le r\u00e9seau souhait\u00e9 : Pour les d\u00e9tails concernants la configuration c\u00f4t\u00e9 PfSense , se r\u00e9f\u00e9rer \u00e0 la documentation li\u00e9e.","title":"Les r\u00e9seaux"},{"location":"proxmox/#gestion-des-acces","text":"","title":"Gestion des acc\u00e8s"},{"location":"proxmox/#les-utilisateurs","text":"Pour cr\u00e9er un utilisateur on se rend dans la rubrique des gestion des utilisateurs : Puis on cr\u00e9\u00e9 un nouvel utilisateur : Tip Il existe deux mode d'authentification dans proxmox : La premi\u00e8re est la PAM qui est h\u00e9rit\u00e9e de l'authentification Linux . La seconde est la PVE qui est l'authentification relative \u00e0 Proxmox . Dans le premier cas, l'authentification se trouve au niveau du serveur, et un acc\u00e8s au shell notamment SSH est possible. Dans le second cas, l'authentification n'est valide qu'au niveau applicatif (WebUI Proxmox). Info Les comptes PAM seront d\u00e9livr\u00e9s aux collaborateurs succeptibles de participer \u00e0 la maintenance de l'hyperviseur ou \u00e0 intervenir dessus en cas de probl\u00e8mes.","title":"Les utilisateurs"},{"location":"proxmox/#les-groups","text":"Il existe plusieurs groupes correspondant au diff\u00e9rents projets : Admin Operator Default Support Casio Ces groupes correspondent aux diff\u00e9rentes activit\u00e9s sur l'hyperviseur.","title":"Les groups"},{"location":"proxmox/#les-pools","text":"Les pools regroupent les machines virtuelles par projets ou par utilisation. Chaque Pool dispose d'une restriction d'acc\u00e8s ne permettant qu'aux utilisateur faisant parti du groupe correspondant d'avoir acc\u00e8s aux ressources pr\u00e9sentes dans le Pool.","title":"Les pools"},{"location":"proxmox/#authentification-double-facteur","text":"Pour activer l'authentification multi facteur, il suffit de d\u00e9rouler le menu utilisateur en haut \u00e0 droite de l'interface web puis de s\u00e9lectionner le TFA. Cela aura pour effet de rediriger sur l'interface de gestion des TFA. Il suffit ensuite de s\u00e9lectionner son utilisateur puis de cliquer sur ajouter pour configurer l'acc\u00e8s. Copiez le secret dans votre application de gestion de jetons puis renseignez le code g\u00e9n\u00e9r\u00e9 par l'application ainsi que le mot de passe du compte pour valider la configuration du TFA.","title":"Authentification double facteur"},{"location":"proxmox/#problemes-connus","text":"Une des mise \u00e0 jour du noyau du syst\u00e8me a r\u00e9ussi \u00e0 casser le programme de d\u00e9marrage ( GRUB ). Le serveur a donc red\u00e9marr\u00e9 en mode urgence. Dans le shell BusyBox , il a suffit d'importer \u00e0 nouveau le pool ZFS qui \u00e9tait vu comme appartenant \u00e0 un autre syst\u00e8me. En IPMI , ex\u00e9cuter la commande suivante : zpool import -f zp0 Pour finir, toujours en IPMI , \u00e9teindre le serveur, puis le red\u00e9marrer et attendre qu'il d\u00e9marre correctement.","title":"Probl\u00e8mes connus"},{"location":"proxmox/#gestion-de-la-virtualisation","text":"","title":"Gestion de la virtualisation"},{"location":"proxmox/#gestion-des-images-iso","text":"Illustration de l'ajout d'une image ISO au d\u00e9p\u00f4t : T\u00e9l\u00e9charger une ISO depuis une url avec le bouton Download. (droits administrateurs requis) T\u00e9l\u00e9charger une ISO depuis sa machine avec le bouton Upload. Supprimer une ISO en la s\u00e9lectionnant puis cliquer sur Supprimer.","title":"Gestion des images ISO"}]}